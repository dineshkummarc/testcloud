#!/usr/bin/env php
<?php

require(dirname(__FILE__).'/../vendor/autoload.php');
require(dirname(__FILE__).'/../lib/Zmsg.php');

$options = new \Ergo\Console\Options($argv,array(
	'--help','-h','--upstream?=NULL','--workers?=tcp://*:2225','--clients?=tcp://*:2224'
));

// show help
if($options->has('-h','--help') || $options->errors())
{
	$options->printErrors();

	echo "\nusage: $argv[0] [..args] testfile\n\n";
	echo " --help             : this documentation\n";
	echo " --upstream addr    : connect to an upstream broker\n";
	echo " --workers addr     : where to listen for workers\n";
	echo " --clients addr     : where to listen for clients\n";
	echo "\n";
	exit(1);
}

$context = new ZMQContext();

if($options->has('--upstream'))
{
	$frontend = new ZMQSocket($context, ZMQ::SOCKET_DEALER);
	$frontend->setSockOpt(ZMQ::SOCKOPT_IDENTITY, trim(`hostname`)."#broker".getmypid());	
	$frontend->connect($upstreamConnect = $options->value('--upstream'));
	echo "Connecting upstream to $upstreamConnect\n";
}
else
{
	$frontend = new ZMQSocket($context, ZMQ::SOCKET_ROUTER);
	$frontend->bind($clientBind = $options->value("--clients"));
	echo "Listening for clients on $clientBind\n";
}

$backend = new ZMQSocket($context, ZMQ::SOCKET_ROUTER);
$backend->bind($workerBind = $options->value("--workers"));
echo "Listening for workers on $workerBind\n";

$workers = new SplPriorityQueue();

while(true)
{
	$readable = $writable = array();
  $poll = new ZMQPoll();

  // poll front-end only if we have available workers
  if(count($workers) > 0)
    $poll->add($frontend, ZMQ::POLL_IN);

  $poll->add($backend, ZMQ::POLL_IN);
  $events = $poll->poll($readable, $writeable);

	foreach($readable as $socket)
	{
		$zmsg = new Zmsg($socket);
		$zmsg->recv();

		if($socket === $backend)
		{
			$identity = $zmsg->unwrap();
			printf("W (%s): %s\n", $identity, $zmsg->body());

			// control messages from the worker
			if($zmsg->parts() == 1 && $zmsg->address() == "READY")
				$workers->insert($identity, 1);

			$zmsg->set_socket($frontend)->send();
		}
		else if($socket === $frontend)
		{
			printf("C: %s\n", $zmsg->body());

			$zmsg->wrap($workers->extract(), "");
			$zmsg->set_socket($backend)->send();
		}
	}
}

