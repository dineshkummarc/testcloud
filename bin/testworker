#!/usr/bin/env php
<?php

require(dirname(__FILE__).'/../vendor/autoload.php');
require(dirname(__FILE__).'/../lib/Zmsg.php');

$options = new \Ergo\Console\Options($argv,array(
	'--help','-h','--connect=NULL'
));

// show help
if($options->has('-h','--help') || $options->errors())
{
	$options->printErrors();

	echo "\nusage: $argv[0] [..args] testfile\n\n";
  echo " --connect broker   : connect to broker, instead of localhost\n";
	echo " --help             : this documentation\n";
	echo "\n";
	exit(1);
}

$endpoint = $options->value('--connect') ?: 'tcp://localhost:2225';
printf("Connecting to %s for tests\n", $endpoint);

$context = new ZMQContext();
$worker = $context->getSocket(ZMQ::SOCKET_DEALER);
$worker->setSockOpt(ZMQ::SOCKOPT_IDENTITY, trim(`hostname`)."#worker".getmypid());
$worker->connect($endpoint);

$running = true;
$cwd = getcwd();

while($running)
{
	// tell the broker we are ready for a test
	$worker->send("READY");

	// wait till we get a test
	$zmsg = new Zmsg($worker);
	$zmsg->recv();

	$body = $zmsg->body();
	$req = json_decode($body);

	$timer = microtime(true);
	$dir = isset($req->cwd) ? realpath($req->cwd) : $cwd;

	echo "C: $req->cmd (in $dir)\n";

	// tell the worker we have queued the test
	$zmsg->body_set("QUEUED $body");
	$zmsg->send(false);

	$proc = proc_open(
		"$req->cmd 2>&1",
		array(1=>array('pipe','w')),
		$pipes,
		$dir
	);

	$stdout = stream_get_contents($pipes[1]);
	echo "$stdout\n";

	fclose($pipes[1]);
  $exitcode = proc_close($proc);

	$r = array(
		'cmd'=>$req->cmd,
		'exitcode'=>$exitcode,
		'stdout'=>$stdout,
		'time'=>(microtime(true)-$timer)*1000
	);

	$zmsg->body_set('RESULT '.json_encode($r));
	$zmsg->send();
}

$env->destroy();
